"use strict";!function(a){function b(){L=a("#code").html(),M=L.replace(/<br>/g,"\n").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/&amp;/g,"&").replace(/&nbsp;/g," "),G(),l(),K||(w(),!K&&n()),a(".exec").hide(),a(".edit").show(),a("#code").attr("contenteditable","false")}function c(){a(".exec").show(),a(".edit").hide(),a("#code").html(L),a("#code").attr("contenteditable","true"),I("")}function d(a,b,c,d){1e4>T.length?"OPER"===a?(T.push(["OPERBEG",b,c,d||"~~"]),T.push(["OPEREND",b,c,d||"~~"])):T.push([a,b,c,d||"~~"]):(U=!0,I("max replay reached (possible infinite loop)"))}function e(){do f();while("EXPRBEG"!==T[V][0]&&"PROGEND"!==T[V][0]&&V<T.length)}function f(){if(!(V>=T.length-1))switch(V++,I(T[V][3]),T[V][0]){case"STMTBEG":j("mark",!0,T[V][1]);break;case"STMTEND":j("mark",!1,T[V][1]);break;case"EXPRBEG":j("expr",!0,T[V][1]);break;case"EXPREND":i(T[V][1],T[V][2]);break;case"OPERBEG":j("mark",!0,T[V][1]);break;case"OPEREND":i(T[V][1],T[V][2],"expr");break;case"PROGEND":case"REPMAX":}}function g(){do h();while("EXPRBEG"!==T[V][0]&&"PROGBEG"!==T[V][0]&&0<V)}function h(){if(!(0>=V)){switch(T[V][0]){case"STMTBEG":j("mark",!1,T[V][1]);break;case"STMTEND":j("mark",!0,T[V][1]);break;case"EXPRBEG":j("expr",!1,T[V][1]);break;case"EXPREND":i(T[V][2],T[V][1],"expr");break;case"OPERBEG":j("mark",!1,T[V][1]);break;case"OPEREND":i(T[V][2],T[V][1],"expr mark");break;case"PROGEND":case"REPMAX":}V--,I(T[V][3])}}function i(b,c,d){b=H(b),a("#tok"+b[0]).replaceWith("<span id=replace></span>");for(var e=1;e<b.length;++e)a("#tok"+b[e]).remove();c=H(c),a("#replace").replaceWith(k(c,d))}function j(b,c,d){d="number"==typeof d?[d]:H(d);for(var e=0;e<d.length;e++)c?a("#tok"+d[e]).addClass(b):a("#tok"+d[e]).removeClass(b)}function k(a,b){var c="",d=0;for("number"==typeof a&&(a=[a]);d<a.length;++d)c+="<span id=\"tok"+a[d]+"\" class=\""+m(a[d])+" "+(b||"")+"\">"+N[a[d]].wspace+"<i>"+N[a[d]].value+"</i></span>";return c}function l(){a("#code").html("");for(var b=1;b<N.length-1;++b)a("#code").append(k(b))}function m(a){switch(N[a].token){case"ERROR":return"error";case"NUMBER":return"const";case"IDENTIFIER":return"const";case"COMMENT":return"comment";default:return"";}}function n(){R=-1,T=[],V=0,d("PROGBEG",null,null,"begin program"),o(P),d("PROGEND",null,null,"end program")}function o(a,c){for(var d=[""],c=c||0;!U&&!K&&c<a.length&&(d=p(a[c]),!d[0]);++c);return d}function p(a){var c=[""];switch(a[0]){case"IF":d("STMTBEG",a[1],null,"begin if statement"),t(s(q(a[2])))?c=p(a[3]):0!==a[4]&&(d("STMTBEG",a[4],null,"begin else statement"),c=p(a[5]),d("STMTEND",a[4],null,"end else statement")),d("STMTEND",a[1],null,"end if statement");break;case"WHILE":for(d("STMTBEG",a[1],null,"begin while statement");!U&&!K&&t(s(q(a[2])));)if(c=p(a[3]),"BREAK"===c[0]){c=[""];break}else"CONTINUE"===c[0]&&(c=[""]);d("STMTEND",a[1],null,"end while statement");break;case"FOR":for(d("STMTBEG",a[1],null,"begin for statement"),q(a[2]);!U&&!K&&t(s(q(a[3])));q(a[4]))if(c=p(a[5]),"BREAK"===c[0]){c=[""];break}else"CONTINUE"===c[0]&&(c=[""]);d("STMTEND",a[1],null,"end for statement");break;case"DO":d("STMTBEG",[a[1],a[3]],null,"begin do while statement");do p(a[2]);while(!U&&!K&&t(s(q(a[4]))));d("STMTEND",[a[1],a[3]],null,"end do while statement");break;case"BREAK":d("STMTBEG",a[1],null,"begin break statement"),c=["BREAK"],d("STMTEND",a[1],null,"begin break statement");break;case"CONTINUE":d("STMTBEG",a[1],null,"continue statement"),c=["CONTINUE"],d("STMTEND",a[1],null,"continue statement");break;case"SWITCH":d("STMTBEG",a[1],null,"begin switch statement");for(var e=s(q(a[2])),f=0;f<a[3][1].length;++f)if("CASE"===a[3][1][f][0]){if(d("STMTBEG",a[3][1][f][1],null,"begin case statement"),t(e)===t(s(q(a[3][1][f][2])))){d("STMTEND",a[3][1][f][1],null,"end case statement true"),c=o(a[3][1],f++);break}else d("STMTEND",a[3][1][f][1],null,"end case statement false");}else if("DEFAULT"===a[3][1][f][0]){d("STMTBEG",a[3][1][f][1],null,"begin default statement"),d("STMTEND",a[3][1][f][1],null,"end default statement"),c=o(a[3][1],f++);break}d("STMTEND",a[1],null,"end switch statement");break;case"CASE":case"DEFAULT":break;case"BLOCK":c=o(a[1]);break;case"EXPR":q(a[1]);}return c}function q(a){var b=1,c=a.slice();for(a=a.slice(),"TOP"===a[0]&&d("EXPRBEG",c,null,"begin expression");b<a.length&&!U;++b)"object"==typeof a[b]&&(a[b]=r(a[b]));return"TOP"===a[0]&&d("EXPREND",a,c,"end expression"),a}function r(a){var b=0;if("number"==typeof a)return a;if("number"==typeof a[0])return a;switch(a=a.slice(),a[0]){case"()":b=s(q(a)),d("OPER",a,b,"resolve sub expression");break;case"?:":b=s(q(a));case"sub[]":break;case"&&":a[1]=r(a[1]),t(a[1])?(a[3]=r(a[3]),t(a[3])?(b=v("BOOL",!0,a[1]),d("OPER",a,b,"logic && true")):(b=v("BOOL",!1,a[1]),d("OPER",a,b,"logic && false"))):(b=v("BOOL",!1,a[1]),d("OPER",a,b,"logic && false short-cicuit"));break;case"||":a[1]=r(a[1]),t(a[1])?(b=v("BOOL",!0,a[1]),d("OPER",a,b,"logic || true short-cicuit")):(a[3]=r(a[3]),t(a[3])?(b=v("BOOL",!0,a[1]),d("OPER",a,b,"logic || true")):(b=v("BOOL",!1,a[1]),d("OPER",a,b,"logic || false")));break;case"?":a[1]=r(a[1]),t(a[1])?(d("OPER",a,a[3],"ternary true"),a=a[3],b=r(a)):(d("OPER",a,a[5],"ternary false"),a=a[5],b=r(a));break;case"??":break;case"n++":F(a[1])?(b=v("NUMBER",t(a[1]),a[1]),u(a[1],v("NUMBER",t(a[1])+1,a[1])),d("OPER",a,b,"postfix increment")):J("expecting identifier",a[1]);break;case"n--":F(a[1])?(b=v("NUMBER",t(a[1]),a[1]),u(a[1],v("NUMBER",t(a[1])-1,a[1])),d("OPER",a,b,"prefix decrement")):J("expecting identifier",a[1]);break;case"++n":F(a[2])?(b=v("NUMBER",t(a[2])+1,a[1]),u(a[2],b),d("OPER",a,b,"prefix increment")):J("expecting identifier",a[2]);break;case"--n":F(a[2])?(b=v("NUMBER",t(a[2])-1,a[1]),u(a[2],b),d("OPER",a,b,"prefix decrement")):J("expecting identifier",a[2]);break;case"!":a[2]=r(a[2]),b=v("BOOL",!t(a[2]),a[1]),d("OPER",a,b,"logic not");break;case"-n":a[2]=r(a[2]),b=v("NUMBER",-t(a[2]),a[1]),d("OPER",a,b,"negative unary");break;case"+n":a[2]=r(a[2]),b=v("NUMBER",+t(a[2]),a[1]),d("OPER",a,b,"plus unary");break;case"*":a[1]=r(a[1]),a[3]=r(a[3]),b=v("NUMBER",t(a[1])*t(a[3]),a[1]),d("OPER",a,b,"multiplication");break;case"/":a[1]=r(a[1]),a[3]=r(a[3]),b=v("NUMBER",t(a[1])/t(a[3]),a[1]),d("OPER",a,b,"division");break;case"%":a[1]=r(a[1]),a[3]=r(a[3]),b=v("NUMBER",t(a[1])%t(a[3]),a[1]),d("OPER",a,b,"modular");break;case"+":a[1]=r(a[1]),a[3]=r(a[3]),b=v("NUMBER",t(a[1])+t(a[3]),a[1]),d("OPER",a,b,"addition");break;case"-":a[1]=r(a[1]),a[3]=r(a[3]),b=v("NUMBER",t(a[1])-t(a[3]),a[1]),d("OPER",a,b,"subtraction");break;case"==":a[1]=r(a[1]),a[3]=r(a[3]),b=v("BOOL",t(a[1])===t(a[3]),a[1]),d("OPER",a,b,"comparison equal");break;case"!=":a[1]=r(a[1]),a[3]=r(a[3]),b=v("BOOl",t(a[1])!==t(a[3]),a[1]),d("OPER",a,b,"comparison not equal");break;case"<":a[1]=r(a[1]),a[3]=r(a[3]),b=v("BOOL",t(a[1])<t(a[3]),a[1]),d("OPER",a,b,"comparison equal");break;case"<=":a[1]=r(a[1]),a[3]=r(a[3]),b=v("BOOL",t(a[1])<=t(a[3]),a[1]),d("OPER",a,b,"comparison less than equal");break;case">":a[1]=r(a[1]),a[3]=r(a[3]),b=v("BOOL",t(a[1])>t(a[3]),a[1]),d("OPER",a,b,"comparison equal");break;case">=":a[1]=r(a[1]),a[3]=r(a[3]),b=v("BOOL",t(a[1])>t(a[3]),a[1]),d("OPER",a,b,"comparison greater than equal");break;case"<=>":a[1]=r(a[1]),a[3]=r(a[3]),b=v("NUMBER",t(a[1])<t(a[3])?-1:t(a[1])>t(a[3])?1:0,a[1]),d("OPER",a,b,"SPACESHIP! operator");break;case"=":a[3]=r(a[3]),F(a[1])?(u(a[1],a[3]),b=v(N[a[3]].token,t(a[3]),a[1]),d("OPER",a,b,"assignment")):J("expecting identifier as left operator",a[1]);}return b}function s(a){for(var b=a.length-1;0<=b;--b)if(-1===[")","]",":",","].indexOf(N[a[b]].token))return a[b];return 0}function t(a){if("object"==typeof a&&(a=s(a)),"IDENTIFIER"===N[a].token){if("undefined"!=typeof N[S[N[a].value]])return N[S[N[a].value]].value;J("undefined variable `"+N[a].value+"`",a)}return N[a].value}function u(a,b){S[N[a].value]=b}function v(a,b,c){return-1+N.push({token:a,value:b,line:N[c].line,wspace:N[c].wspace})}function w(){P=[],Q=[],R=-1,O=1,P=x()}function x(){var a=[],b=[];for(R++;O<N.length&&!K;)if("COMMENT"===N[O].token)O++;else if("}"===N[O].token){O++,0==R&&J("unexpected b `}`",O++);break}else if("EndFile"===N[O].token){0<R&&J("unexpected `EndFile`, missing `}`",O++);break}else b=y(),b[0]&&a.push(b);return R--,a}function y(a){var b=[];switch(a&&Q.push(a),N[O].token){case"COMMENT":b=["",O++];break;case"IF":b=["IF",O++,[],[],0,[]],"("===N[O].token?(O++,b[2]=z("TOP",")"),b[3]=y("IF"),"ELSE"===N[O].token&&(b[4]=O++,b[5]=y("ELSE"))):J("require `(` after `if`",O);break;case"ELSE":J("`else` statements must follow `if`",O);break;case"WHILE":b=["WHILE",O++,[],[]],"("===N[O].token?(O++,b[2]=z("TOP",")"),b[3]=y("WHILE")):J("require `(` after `while`",O);break;case"FOR":b=["FOR",O++,[],[],[],[]],"("===N[O].token?(O++,b[2]=z("TOP",";"),b[3]=z("TOP",";"),b[4]=z("TOP",")"),b[5]=y("FOR")):J("require `(` after `while`",O);break;case"DO":b=["DO",O++,[],0,[]],b[2]=y("DO"),"WHILE"===N[O].token?(b[3]=O++,"("===N[O].token?(O++,b[4]=z("TOP",")"),";"===N[O].token?O++:J("require `;` after `do while()`",O)):J("require `(` after `while`",O)):J("require `while` after `do``stmt|block`",O);break;case"BREAK":b=["BREAK",O++],-1<Q.indexOf("WHILE")||-1<Q.indexOf("FOR")||-1<Q.indexOf("DO")||-1<Q.indexOf("SWITCH")?(";"!==N[O].token&&J("expecting `;` after `break`",O),O++):J("`break` must be inside `while`, `for`, `do` or `switch` scope",O++);break;case"CONTINUE":b=["CONTINUE",O++],-1<Q.indexOf("WHILE")||-1<Q.indexOf("FOR")||-1<Q.indexOf("DO")?(";"!==N[O].token&&J("expecting `;` after `continue`",O),O++):J("`continue` must be inside `while`, `for` or `do` scope",O++);break;case"SWITCH":b=["SWITCH",O++,[],[]],"("===N[O].token?(O++,b[2]=z("TOP",")"),"{"===N[O].token?b[3]=y("SWITCH"):J("require `{` block after `switch( expr )`",O)):J("require `(` after `switch`",O);break;case"CASE":b=["CASE",O++,[]],b[2]=z("TOP",":");break;case"DEFAULT":b=["DEFAULT",O++],":"!==N[O++].token&&J("require `:` after `default`",O-1);break;case"{":O++,b=["BLOCK",x()];break;default:b=["EXPR",z("TOP",";")];}return a&&Q.pop(a),b}function z(a,b,c){var d=[a],f=0,g=0;c&&(d[++f]=c),d[++f]=[];out:for(;O<N.length&&!K;)switch(N[O].token){case"COMMENT":O++;break;case",":d[++f]=O++,d[++f]=[];break;case"(":d[f].push(z("()",")",O++));break;case"[":d[f].push(z("[]","]",O++));break;case"?":d[f].push(O++),d[f].push(z("?:",":")),d[f].push(O++);break;case")":case"]":case":":case";":N[O].token!==b&&J("require `"+b+"`, unexpected `"+N[O].token+"`",O),"TOP"!==a&&":"!==N[O].token&&d.push(O),"?:"!==a&&O++;break out;case"IDENTIFIER":case"BOOL":case"NUMBER":case"STRING":case"==":case"!=":case"<=>":case"<=":case"<":case">=":case">":case"&&":case"||":case"!":case"=":case"*=":case"/=":case"+=":case"-=":case"*":case"/":case"%":case"+":case"-":case"++":case"--":d[f].push(O++);break;default:J("invalid expression token `"+N[O].token+"` ",O++);}for(f=1;f<d.length;++f)if("object"==typeof d[f]){if(0===d[f].length){J("empty expression ",d);continue}for(g=0;g<d[f].length;++g)if("number"==typeof d[f][g])switch(N[d[f][g]].token){case"++":F(d[f][g-1])&&B(d[f],"n++",g--);break;case"--":F(d[f][g-1])&&B(d[f],"n--",g--);break;case"IDENTIFIER":"object"==typeof d[f][g+1]&&"()"===d[f][g][0]&&B(d[f],"func",g--);}else"object"==typeof d[f][g]&&"[]"===d[f][g][0]&&E(d[f][g-1])&&B(d[f],"sub[]",g--);for(g=d[f].length-1;0<=g;--g)if("number"==typeof d[f][g])switch(N[d[f][g]].token){case"!":C(d[f],"!",g);break;case"++":C(d[f],"++n",g);break;case"--":C(d[f],"--n",g);break;case"-":E(d[f][g-1])||C(d[f],"-n",g);break;case"+":E(d[f][g-1])||C(d[f],"+n",g);}for(g=0;g<d[f].length;++g)if("number"==typeof d[f][g])switch(N[d[f][g]].token){case"*":A(d[f],"*",g--);break;case"/":A(d[f],"/",g--);break;case"%":A(d[f],"%",g--);}for(g=0;g<d[f].length;++g)if("number"==typeof d[f][g])switch(N[d[f][g]].token){case"+":A(d[f],"+",g--);break;case"-":A(d[f],"-",g--);}for(g=0;g<d[f].length;++g)if("number"==typeof d[f][g])switch(N[d[f][g]].token){case"<":A(d[f],"<",g--);break;case"<=":A(d[f],"<=",g--);break;case">":A(d[f],">",g--);break;case">=":A(d[f],">=",g--);}for(g=0;g<d[f].length;++g)if("number"==typeof d[f][g])switch(N[d[f][g]].token){case"==":A(d[f],"==",g--);break;case"!=":A(d[f],"!=",g--);break;case"<=>":A(d[f],"<=>",g--);}for(g=0;g<d[f].length;++g)if("number"==typeof d[f][g])switch(N[d[f][g]].token){case"&&":A(d[f],"&&",g--);}for(g=0;g<d[f].length;++g)if("number"==typeof d[f][g])switch(N[d[f][g]].token){case"||":A(d[f],"||",g--);}for(g=d[f].length-1;0<=g;--g)if("number"==typeof d[f][g])switch(N[d[f][g]].token){case"?":D(d[f],"?",g);break;case"??":A(d[f],"?:",g);}for(g=d[f].length-1;0<g;--g)if("number"==typeof d[f][g])switch(N[d[f][g]].token){case"=":A(d[f],"=",g--);break;case"*=":A(d[f],"*=",g--);break;case"/=":A(d[f],"/=",g--);break;case"%=":A(d[f],"%=",g--);break;case"+=":A(d[f],"+=",g--);break;case"-=":A(d[f],"-=",g--);}1===d[f].length?"object"==typeof d[f][0]&&(d[f]=d[f][0]):J("could not resolve expression",d[f])}return d}function A(a,b,c){a.splice(c-1,3,[b,a[c-1]||0,a[c],a[c+1]||0])}function B(a,b,c){a.splice(c-1,2,[b,a[c-1]||0,a[c]])}function C(a,b,c){a.splice(c,2,[b,a[c],a[c+1]||0])}function D(a,b,c){a.splice(c-1,5,[b,a[c-1]||0,a[c],a[c+1]||0,a[c+2]||0,a[c+3]||0])}function E(a){return"object"==typeof a||"number"==typeof a&&-1<["IDENTIFIER","NUMBER","STRING","BOOL"].indexOf(N[a].token)}function F(a){return"number"==typeof a&&"IDENTIFIER"===N[a].token}function G(){var a=M,b=0,c=1,d=[],e="";for(N=[{token:"BegFile",value:"",line:1,ws:""}];b<W.length&&0<a.length&&!K;++b)0===b&&(e=a.match(/^\s*/)[0],a=a.substr(e.length),c+=e.match(/\n|$/g).length-1),(d=a.match(W[b][1]))&&(d=d[1]||d[0],a=a.substr(d.length),c+=d.match(/\n|$/g).length-1,"function"==typeof W[b][2]&&(d=W[b][2](d)),N.push({token:W[b][0],value:d,line:c,wspace:e}),b=-1);return N.push({token:"EndFile",value:"{EndFile}",line:c,ws:""}),!a}function H(a){var b=[],c=0,d=0,e=[];if("number"==typeof a)return[a];if("object"==typeof a)for(;c<a.length;++c)if("number"==typeof a[c])b.push(a[c]);else if("object"==typeof a[c])for(e=H(a[c]),d=0;d<e.length;++d)b.push(e[d]);return b}function I(b){a("#msg").html(b)}function J(a,b){return"number"==typeof b?I("error line "+N[b].line+" token`"+N[b].token+"` value`"+N[b].value+"` msg:\""+a+"\" "):"object"==typeof b&&(b=H(b),0<b.length?I("error near line "+N[b[0]].line+" token`"+N[b[0]].token+"` value`"+N[b[0]].value+"` - \""+a+"\" "):I("error \""+a+"\"")),K=!0}var K="",L="",M="",N=[],O=1,P=[],Q=[],R=0,S={},T=[],U=!1,V=0;window.run=b,window.edit=c,window.prevExpr=g,window.nextExpr=e,window.prev=h,window.next=f;var W=[["COMMENT",/^\/\/[^\n]*(?:\n|$)/],["COMMENT",/^\/\*[^]*\*\//],["IF",/^(if)(?![_a-zA-Z0-9])/],["ELSE",/^(else)(?![_a-zA-Z0-9])/],["SWITCH",/^(switch)(?![_a-zA-Z0-9])/],["CASE",/^(case)(?![_a-zA-Z0-9])/],["DEFAULT",/^(default)(?![_a-zA-Z0-9])/],["WHILE",/^(while)(?![_a-zA-Z0-9])/],["FOR",/^(for)(?![_a-zA-Z0-9])/],["DO",/^(do)(?![_a-zA-Z0-9])/],["BREAK",/^(break)(?![_a-zA-Z0-9])/],["CONTINUE",/^(continue)(?![_a-zA-Z0-9])/],["FUNCTION",/^(function)(?![_a-zA-Z0-9])/],["RETURN",/^(return)(?![_a-zA-Z0-9])/],["ECHO",/^(echo)(?![_a-zA-Z0-9])/],["VAR",/^(var)(?![_a-zA-Z0-9])/],["<=>",/^<=>/],["==",/^==/],["!=",/^==|<>/],["<=",/^<=/],["<",/^</],[">=",/^>=/],[">",/^>/],["&&",/^\&\&/],["||",/^\|\|/],["!",/^\!/],["?",/^\?/],["++",/^\+\+/],["--",/^\-\-/],["=",/^=/],["*=",/^\*=/],["/=",/^\/=/],["%=",/^%=/],["+=",/^\+=/],["-=",/^\-=/],["*",/^\*/],["/",/^\//],["%",/^%/],["+",/^\+/],["-",/^\-/],[";",/^;/],[",",/^,/],[":",/^:/],["(",/^\(/],[")",/^\)/],["[",/^\[/],["]",/^\]/],["{",/^\{/],["}",/^\}/],["BOOL",/^(true|false)(?![_a-zA-Z0-9])/,function(a){return!("true"!==a)}],["NUMBER",/^[0-9]*\.?[0-9]+/,Number],["IDENTIFIER",/^[_a-zA-Z][_a-zA-Z0-9]*/],["ERROR",/^./]]}($);
